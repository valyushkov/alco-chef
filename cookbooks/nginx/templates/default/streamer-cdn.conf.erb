proxy_cache_path <%= node[:nginx][:local_cache_path].to_s %> levels=1:2 keys_zone=local_cache:128m inactive=7d max_size=300g;


proxy_cache_valid 200 302 4d;
proxy_cache_valid 404 403 1m;

proxy_cache_min_uses 1;
proxy_cache_use_stale timeout http_500;
proxy_connect_timeout 3;

proxy_cache_key $request_uri;

proxy_temp_path <%= node[:nginx][:cache_temp_path].to_s %>;

upstream cdn {
    server <%= node[:nginx][:upstream_url].to_s %>;
}

server {
    listen 8000;

    location / {
        proxy_cache local_cache;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 10s;

        proxy_pass http://cdn;
    }
}